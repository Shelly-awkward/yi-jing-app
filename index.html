<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ˜“ç¶“è“è‰å åœ</title>
    <style>
        body {
            font-family: 'Microsoft JhengHei', 'å¾®è»Ÿæ­£é»‘é«”', sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #2c3e50;
            border-bottom: 3px solid #3498db;
            padding-bottom: 10px;
        }
        .input-section {
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        textarea {
            width: 100%;
            height: 60px;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
            resize: vertical;
        }
        button {
            background: #3498db;
            color: white;
            padding: 12px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 5px;
            transition: background 0.3s;
        }
        button:hover {
            background: #2980b9;
        }
        .result-section {
            margin-top: 20px;
            padding: 20px;
            background: #fff;
            border: 2px solid #ecf0f1;
            border-radius: 10px;
        }
        .hexagram-display {
            text-align: center;
            font-size: 24px;
            margin: 20px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        .yao-line {
            margin: 5px 0;
            font-family: monospace;
        }
        .changing {
            color: #e74c3c;
            font-weight: bold;
        }
        .log-output {
            background: #2c3e50;
            color: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .file-input {
            margin: 10px 0;
            padding: 10px;
            border: 2px dashed #bdc3c7;
            border-radius: 5px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ‹ æ˜“ç¶“è“è‰å åœ ğŸ‹</h1>
        
        <div class="input-section">
            <h3>ğŸ“Š è³‡æ–™åº«ç‹€æ…‹</h3>
            <div id="databaseStatus" class="file-input">
                <p>ğŸ”„ æ­£åœ¨è¼‰å…¥å¦è±¡è³‡æ–™åº«...</p>
            </div>
        </div>

        <div class="input-section">
            <h3>â“ è«‹è¼¸å…¥æ‚¨çš„å•é¡Œ</h3>
            <textarea id="questionInput" placeholder="ä¾‹å¦‚ï¼šä»Šå¹´çš„äº‹æ¥­é‹å‹¢å¦‚ä½•ï¼Ÿè«‹æŒ‡ç¤ºæ˜è·¯..."></textarea>
            <br>
            <button onclick="startDivination()">ğŸ”® é–‹å§‹å åœ</button>
            <button onclick="clearResults()">ğŸ—‘ï¸ æ¸…é™¤çµæœ</button>
        </div>

        <div id="resultSection" class="result-section" style="display: none;">
            <h3>ğŸ“Š å åœçµæœ</h3>
            <div id="hexagramDisplay" class="hexagram-display"></div>
            <div id="resultText"></div>
        </div>

        <div id="logSection" style="display: none;">
            <h3>ğŸ“ è©³ç´°éç¨‹</h3>
            <div id="logOutput" class="log-output"></div>
        </div>
    </div>

    <script>
        // æ˜“ç¶“è“è‰å åœé¡åˆ¥
        class IChingDivination {
            constructor() {
                this.totalSticks = 50;
                this.workingSticks = 49;
                this.hexagramLines = [];
                this.hexagramDatabase = null;
                this.logMessages = [];
            }

            // è¼‰å…¥å¦è±¡è³‡æ–™åº«
            async loadHexagramDatabase() {
                try {
                    // å˜—è©¦å¾åŒç›®éŒ„è¼‰å…¥è³‡æ–™åº«æ–‡ä»¶
                    const response = await fetch('./hexagram_database.txt');
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const fileContent = await response.text();
                    this.hexagramDatabase = this.parseDatabase(fileContent);
                    this.log('âœ… å¦è±¡è³‡æ–™åº«è¼‰å…¥æˆåŠŸï¼');
                    return true;
                } catch (error) {
                    this.log('âŒ è¼‰å…¥å¤–éƒ¨è³‡æ–™åº«å¤±æ•—ï¼Œä½¿ç”¨å…§å»ºç°¡åŒ–ç‰ˆæœ¬');
                    this.log(`éŒ¯èª¤è¨Šæ¯: ${error.message}`);
                    this.hexagramDatabase = this.getBuiltInDatabase();
                    return false;
                }
            }

            // è§£æè³‡æ–™åº«å…§å®¹
            parseDatabase(content) {
                const database = {};
                const lines = content.split('\n');
                
                for (const line of lines) {
                    if (line.startsWith('#') || line.trim() === '') continue;
                    
                    const parts = line.split('|');
                    if (parts.length >= 6) {
                        const [åºè™Ÿ, äºŒé€²åˆ¶, å¦å, å¦è¾­, ...çˆ»è¾­] = parts;
                        database[äºŒé€²åˆ¶] = {
                            åºè™Ÿ: åºè™Ÿ,
                            å¦å: å¦å,
                            å¦è¾­: å¦è¾­,
                            çˆ»è¾­: çˆ»è¾­
                        };
                    }
                }
                
                return database;
            }

            // å…§å»ºç°¡åŒ–è³‡æ–™åº«ï¼ˆå‚™ç”¨ï¼‰
            getBuiltInDatabase() {
                return {
                    '111111': { åºè™Ÿ: '01', å¦å: 'ä¹¾', å¦è¾­: 'å…ƒäº¨åˆ©è²', çˆ»è¾­: ['åˆä¹ï¼šæ½›é¾å‹¿ç”¨', 'ä¹äºŒï¼šè¦‹é¾åœ¨ç”°ï¼Œåˆ©è¦‹å¤§äºº', 'ä¹ä¸‰ï¼šå›å­çµ‚æ—¥ä¹¾ä¹¾ï¼Œå¤•æƒ•è‹¥å²ï¼Œç„¡å’', 'ä¹å››ï¼šæˆ–èºåœ¨æ·µï¼Œç„¡å’', 'ä¹äº”ï¼šé£›é¾åœ¨å¤©ï¼Œåˆ©è¦‹å¤§äºº', 'ä¸Šä¹ï¼šäº¢é¾æœ‰æ‚”'] },
                    '000000': { åºè™Ÿ: '02', å¦å: 'å¤', å¦è¾­: 'å…ƒäº¨ï¼Œåˆ©ç‰é¦¬ä¹‹è²ã€‚å›å­æœ‰æ”¸å¾€ï¼Œå…ˆè¿·å¾Œå¾—ä¸»ï¼Œåˆ©è¥¿å—å¾—æœ‹ï¼Œæ±åŒ—å–ªæœ‹ã€‚å®‰è²å‰', çˆ»è¾­: ['åˆå…­ï¼šå±¥éœœï¼Œå …å†°è‡³', 'å…­äºŒï¼šç›´ï¼Œæ–¹ï¼Œå¤§ï¼Œä¸ç¿’ç„¡ä¸åˆ©', 'å…­ä¸‰ï¼šå«ç« å¯è²ã€‚æˆ–å¾ç‹äº‹ï¼Œç„¡æˆæœ‰çµ‚', 'å…­å››ï¼šæ‹¬å›Šï¼›ç„¡å’ï¼Œç„¡è­½', 'å…­äº”ï¼šé»ƒè£³ï¼Œå…ƒå‰', 'ä¸Šå…­ï¼šé¾æˆ°æ–¼é‡ï¼Œå…¶è¡€ç„é»ƒ'] },
                    '000110': { åºè™Ÿ: '46', å¦å: 'å‡', å¦è¾­: 'å…ƒäº¨ï¼Œç”¨è¦‹å¤§äººï¼Œå‹¿æ¤ï¼Œå—å¾å‰', çˆ»è¾­: ['åˆå…­ï¼šå…å‡ï¼Œå¤§å‰', 'ä¹äºŒï¼šå­šä¹ƒåˆ©ç”¨ç¦´ï¼Œç„¡å’', 'ä¹ä¸‰ï¼šå‡è™›é‚‘', 'å…­å››ï¼šç‹ç”¨äº¨æ–¼å²å±±ï¼Œå‰ç„¡å’', 'å…­äº”ï¼šè²å‰ï¼Œå‡éš', 'ä¸Šå…­ï¼šå†¥å‡ï¼Œåˆ©æ–¼ä¸æ¯ä¹‹è²'] },
                    '010011': { åºè™Ÿ: '60', å¦å: 'ç¯€', å¦è¾­: 'äº¨ã€‚è‹¦ç¯€ä¸å¯è²', çˆ»è¾­: ['åˆä¹ï¼šä¸å‡ºæˆ¶åº­ï¼Œç„¡å’', 'ä¹äºŒï¼šä¸å‡ºé–€åº­ï¼Œå‡¶', 'å…­ä¸‰ï¼šä¸ç¯€è‹¥ï¼Œå‰‡å—Ÿè‹¥ï¼Œç„¡å’', 'å…­å››ï¼šå®‰ç¯€ï¼Œäº¨', 'ä¹äº”ï¼šç”˜ç¯€ï¼Œå‰ï¼›å¾€æœ‰å°š', 'ä¸Šå…­ï¼šè‹¦ç¯€ï¼Œè²å‡¶ï¼Œæ‚”äº¡'] },
                    '010110': { åºè™Ÿ: '48', å¦å: 'äº•', å¦è¾­: 'æ”¹é‚‘ä¸æ”¹äº•ï¼Œç„¡å–ªç„¡å¾—ï¼Œå¾€ä¾†äº•äº•ã€‚æ±”è‡³äº¦æœªç¹˜äº•ï¼Œç¾¸å…¶ç“¶ï¼Œå‡¶', çˆ»è¾­: ['åˆå…­ï¼šäº•æ³¥ä¸é£Ÿï¼ŒèˆŠäº•ç„¡ç¦½', 'ä¹äºŒï¼šäº•è°·å°„é®’ï¼Œç”•æ•æ¼', 'ä¹ä¸‰ï¼šäº•æ¸«ä¸é£Ÿï¼Œç‚ºæˆ‘å¿ƒæƒ»ï¼Œå¯ç”¨æ±²ï¼Œç‹æ˜ï¼Œä¸¦å—å…¶ç¦', 'å…­å››ï¼šäº•ç”ƒï¼Œç„¡å’', 'ä¹äº”ï¼šäº•å†½ï¼Œå¯’æ³‰é£Ÿ', 'ä¸Šå…­ï¼šäº•æ”¶å‹¿å¹•ï¼Œæœ‰å­šå…ƒå‰'] }
                };
            }

            // è¨˜éŒ„æ—¥èªŒ
            log(message) {
                this.logMessages.push(message);
                console.log(message);
            }

            // æ¨¡æ“¬ä¸€æ¬¡åˆ†ç±Œçš„éç¨‹
            performOneDivision(sticks) {
                const leftPile = Math.floor(Math.random() * (sticks - 1)) + 1;
                const rightPile = sticks - leftPile;
                
                let leftRemaining = leftPile - 1;
                let gathered = 1;
                
                const leftRemainder = leftRemaining % 4;
                gathered += (leftRemainder === 0) ? 4 : leftRemainder;
                
                const rightRemainder = rightPile % 4;
                gathered += (rightRemainder === 0) ? 4 : rightRemainder;
                
                return sticks - gathered;
            }

            // å–ä¸€çˆ»çš„éç¨‹ï¼ˆä¸‰è®Šï¼‰
            getOneYao() {
                let sticks = this.workingSticks;
                
                for (let i = 0; i < 3; i++) {
                    sticks = this.performOneDivision(sticks);
                }
                
                const groups = sticks / 4;
                return groups;
            }

            // å®Œæ•´çš„å åœéç¨‹
            async performDivination(question = "è«‹å•é‹å‹¢å¦‚ä½•ï¼Ÿ") {
                this.logMessages = [];
                this.log(`=== æ˜“ç¶“è“è‰å åœ ===`);
                this.log(`å•é¡Œ: ${question}`);
                this.log(`å¤§è¡ä¹‹æ•¸äº”åï¼Œå…¶ç”¨å››åæœ‰ä¹\n`);
                
                this.hexagramLines = [];
                
                // å–å…­çˆ»ï¼Œå¾åˆçˆ»åˆ°ä¸Šçˆ»
                for (let i = 1; i <= 6; i++) {
                    this.log(`--- å–ç¬¬${i}çˆ» ---`);
                    const yaoValue = this.getOneYao();
                    this.hexagramLines.push(yaoValue);
                    
                    const yaoName = i === 6 ? 'ä¸Šçˆ»' : `ç¬¬${i}çˆ»`;
                    this.log(`${yaoName}æ•¸å€¼: ${yaoValue}`);
                }
                
                return await this.interpretHexagram(question);
            }

            // è§£é‡‹å¦è±¡
            async interpretHexagram(question) {
                this.log(`\n=== å¦è±¡è§£é‡‹ ===`);
                this.log('å…­çˆ»æ•¸å€¼ï¼ˆåˆçˆ»åˆ°ä¸Šçˆ»ï¼‰: ' + JSON.stringify(this.hexagramLines));
                
                // ç¢ºå®šé™°é™½çˆ»å’Œè®Šçˆ»
                const yaoSymbols = this.hexagramLines.map((value, index) => {
                    const yaoName = index === 5 ? 'ä¸Šçˆ»' : `ç¬¬${index + 1}çˆ»`;
                    let symbol, type, changing = false;
                    
                    switch (value) {
                        case 6: symbol = 'âš‹'; type = 'è€é™°'; changing = true; break;
                        case 7: symbol = 'âšŠ'; type = 'å°‘é™½'; break;
                        case 8: symbol = 'âš‹'; type = 'å°‘é™°'; break;
                        case 9: symbol = 'âšŠ'; type = 'è€é™½'; changing = true; break;
                        default: symbol = '?'; type = `ç•°å¸¸å€¼${value}`; break;
                    }
                    
                    return { yaoName, symbol, type, changing, value };
                });
                
                // é¡¯ç¤ºçˆ»è±¡ï¼ˆå‚³çµ±æ’åˆ—ï¼šä¸Šçˆ»åœ¨ä¸Šï¼‰
                this.log('\nå¦è±¡é¡¯ç¤ºï¼ˆä¸Šçˆ»åœ¨ä¸Šï¼‰:');
                for (let i = yaoSymbols.length - 1; i >= 0; i--) {
                    const yao = yaoSymbols[i];
                    const changeMark = yao.changing ? ' (è®Š)' : '';
                    this.log(`${yao.yaoName}: ${yao.symbol} ${yao.type}${changeMark}`);
                }
                
                // ç”Ÿæˆæœ¬å¦äºŒé€²åˆ¶ï¼ˆé…åˆè³‡æ–™åº«æ ¼å¼ï¼šéœ€è¦åè½‰é †åºï¼‰
                const originalBinary = this.hexagramLines.map(value => 
                    (value === 7 || value === 9) ? '1' : '0'
                ).reverse().join('');
                
                // ç”Ÿæˆä¹‹å¦äºŒé€²åˆ¶
                const changedBinary = this.hexagramLines.map(value => {
                    if (value === 6) return '1';
                    if (value === 9) return '0';
                    return (value === 7 || value === 9) ? '1' : '0';
                }).reverse().join('');
                
                // è®Šçˆ»ä½ç½®
                const changingLines = this.hexagramLines
                    .map((value, index) => value === 6 || value === 9 ? index + 1 : null)
                    .filter(line => line !== null);
                
                // æŸ¥æ‰¾æœ¬å¦
                const originalHexagram = this.findHexagram(originalBinary);
                const changedHexagram = originalBinary !== changedBinary ? this.findHexagram(changedBinary) : null;
                
                // é¡¯ç¤ºçµæœ
                this.log(`\n=== å åœçµæœ ===`);
                this.log(`å•é¡Œ: ${question}`);
                this.log(`æœ¬å¦: ${originalHexagram.å¦å}å¦ (${originalHexagram.åºè™Ÿ})`);
                this.log(`å¦è¾­: ${originalHexagram.å¦è¾­}`);
                
                if (changedHexagram) {
                    this.log(`ä¹‹å¦: ${changedHexagram.å¦å}å¦ (${changedHexagram.åºè™Ÿ})`);
                    this.log(`ä¹‹å¦å¦è¾­: ${changedHexagram.å¦è¾­}`);
                }
                
                if (changingLines.length > 0) {
                    this.log(`è®Šçˆ»: ç¬¬${changingLines.join('ã€')}çˆ»`);
                    this.log('\nè®Šçˆ»çˆ»è¾­:');
                    changingLines.forEach(lineNum => {
                        const yaoText = originalHexagram.çˆ»è¾­[lineNum - 1];
                        const lineName = lineNum === 6 ? 'ä¸Šçˆ»' : `ç¬¬${lineNum}çˆ»`;
                        this.log(`${lineName}: ${yaoText}`);
                    });
                } else {
                    this.log('ç„¡è®Šçˆ»');
                }
                
                return {
                    question: question,
                    originalHexagram: originalHexagram,
                    changedHexagram: changedHexagram,
                    yaoValues: this.hexagramLines,
                    changingLines: changingLines,
                    originalBinary: originalBinary,
                    changedBinary: changedBinary,
                    yaoSymbols: yaoSymbols,
                    logs: this.logMessages
                };
            }

            // æŸ¥æ‰¾å¦è±¡
            findHexagram(binary) {
                if (this.hexagramDatabase && this.hexagramDatabase[binary]) {
                    return this.hexagramDatabase[binary];
                }
                
                return {
                    åºè™Ÿ: '??',
                    å¦å: 'æœªçŸ¥',
                    å¦è¾­: 'æŸ¥ç„¡æ­¤å¦',
                    çˆ»è¾­: ['', '', '', '', '', '']
                };
            }
        }

        // å…¨åŸŸè®Šæ•¸
        let divination = new IChingDivination();
        let currentResult = null;

        // é é¢è¼‰å…¥æ™‚è‡ªå‹•è¼‰å…¥è³‡æ–™åº«
        window.addEventListener('load', async function() {
            const statusDiv = document.getElementById('databaseStatus');
            try {
                const success = await divination.loadHexagramDatabase();
                if (success) {
                    statusDiv.innerHTML = '<p style="color: green;">âœ… å®Œæ•´64å¦è³‡æ–™åº«è¼‰å…¥æˆåŠŸï¼</p>';
                } else {
                    statusDiv.innerHTML = '<p style="color: orange;">âš ï¸ ä½¿ç”¨å…§å»ºç°¡åŒ–è³‡æ–™åº«ï¼ˆå»ºè­°ä¸Šå‚³å®Œæ•´è³‡æ–™åº«æ–‡ä»¶ï¼‰</p>';
                }
            } catch (error) {
                statusDiv.innerHTML = '<p style="color: red;">âŒ è³‡æ–™åº«è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨å…§å»ºç‰ˆæœ¬</p>';
            }
        });

        // é–‹å§‹å åœ
        async function startDivination() {
            const question = document.getElementById('questionInput').value.trim();
            if (!question) {
                alert('è«‹è¼¸å…¥æ‚¨çš„å•é¡Œï¼');
                return;
            }

            try {
                currentResult = await divination.performDivination(question);
                displayResult(currentResult);
            } catch (error) {
                alert('å åœéç¨‹ç™¼ç”ŸéŒ¯èª¤ï¼š' + error.message);
            }
        }

        // é¡¯ç¤ºçµæœ
        function displayResult(result) {
            const resultSection = document.getElementById('resultSection');
            const hexagramDisplay = document.getElementById('hexagramDisplay');
            const resultText = document.getElementById('resultText');
            const logSection = document.getElementById('logSection');
            const logOutput = document.getElementById('logOutput');

            // é¡¯ç¤ºå¦è±¡
            let hexagramHTML = '<h4>å¦è±¡</h4>';
            for (let i = result.yaoSymbols.length - 1; i >= 0; i--) {
                const yao = result.yaoSymbols[i];
                const className = yao.changing ? 'changing' : '';
                hexagramHTML += `<div class="yao-line ${className}">${yao.yaoName}: ${yao.symbol} ${yao.type}${yao.changing ? ' (è®Š)' : ''}</div>`;
            }
            hexagramDisplay.innerHTML = hexagramHTML;

            // é¡¯ç¤ºçµæœæ–‡å­—
            let resultHTML = `
                <h4>ğŸ“‹ å åœçµæœ</h4>
                <p><strong>å•é¡Œï¼š</strong>${result.question}</p>
                <p><strong>æœ¬å¦ï¼š</strong>${result.originalHexagram.å¦å}å¦ (ç¬¬${result.originalHexagram.åºè™Ÿ}å¦)</p>
                <p><strong>å¦è¾­ï¼š</strong>${result.originalHexagram.å¦è¾­}</p>
            `;

            if (result.changedHexagram) {
                resultHTML += `
                    <p><strong>ä¹‹å¦ï¼š</strong>${result.changedHexagram.å¦å}å¦ (ç¬¬${result.changedHexagram.åºè™Ÿ}å¦)</p>
                    <p><strong>ä¹‹å¦å¦è¾­ï¼š</strong>${result.changedHexagram.å¦è¾­}</p>
                `;
            }

            if (result.changingLines.length > 0) {
                resultHTML += `<p><strong>è®Šçˆ»ï¼š</strong>ç¬¬${result.changingLines.join('ã€')}çˆ»</p>`;
                resultHTML += '<h5>è®Šçˆ»çˆ»è¾­ï¼š</h5>';
                result.changingLines.forEach(lineNum => {
                    const yaoText = result.originalHexagram.çˆ»è¾­[lineNum - 1];
                    const lineName = lineNum === 6 ? 'ä¸Šçˆ»' : `ç¬¬${lineNum}çˆ»`;
                    resultHTML += `<p><strong>${lineName}ï¼š</strong>${yaoText}</p>`;
                });
            } else {
                resultHTML += '<p><strong>è®Šçˆ»ï¼š</strong>ç„¡</p>';
            }

            resultText.innerHTML = resultHTML;

            // é¡¯ç¤ºè©³ç´°éç¨‹
            logOutput.textContent = result.logs.join('\n');

            // é¡¯ç¤ºå€å¡Š
            resultSection.style.display = 'block';
            logSection.style.display = 'block';

            // æ»¾å‹•åˆ°çµæœå€åŸŸ
            resultSection.scrollIntoView({ behavior: 'smooth' });
        }

        // æ¸…é™¤çµæœ
        function clearResults() {
            document.getElementById('questionInput').value = '';
            document.getElementById('resultSection').style.display = 'none';
            document.getElementById('logSection').style.display = 'none';
            currentResult = null;
        }
    </script>
</body>
</html>
